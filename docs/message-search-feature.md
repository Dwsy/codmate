# 消息模糊搜索功能

## 功能描述

在 CodMate 中添加了模糊搜索功能，支持搜索会话文件中的用户消息和助手消息（非工具调用）。

## 实现细节

### 修改的文件
- `services/GlobalSearchService.swift`

### 工作原理

1. **消息提取**：当搜索会话文件时，首先解析 JSONL 文件，提取以下类型的消息：
   - `user_message` - 用户发送的消息
   - `agent_message` - 助手（AI）回复的消息
   - `agent_reasoning` - 助手的推理过程

2. **模糊搜索**：使用现有的模糊搜索算法对这些消息内容进行匹配
   - 支持多关键词搜索（例如："web api" 会匹配包含 "web" 和 "api" 的消息）
   - 自动忽略大小写和变音符号
   - 根据匹配度、时效性和位置进行评分

3. **搜索优先级**：消息匹配结果的权重略高于普通文件内容匹配

4. **结果展示**：搜索结果中会显示消息的来源（User 或 Assistant）和内容摘要

### 搜索范围

该搜索功能覆盖所有会话源：
- Codex 会话 (.codex/sessions)
- Claude 会话 (.claude/projects)
- Gemini 会话 (.gemini/tmp)
- Pi 会话 (如果启用)

### 性能优化

- 内存映射读取：使用内存映射文件读取，减少内存占用
- 提前终止：达到最大匹配数后停止扫描
- 自动降级：如果消息搜索没有结果，自动回退到原始的文件内容扫描

## 使用方法

### 全局搜索

1. 在 CodMate 主界面，使用搜索框（或快捷键 Cmd+Shift+F）
2. 输入搜索关键词，例如："web api"
3. 搜索结果中会显示匹配的消息，格式为：
   - User: [消息内容摘要]
   - Assistant: [消息内容摘要]

### 搜索示例

- 搜索 "react component" - 会找到所有提到 React 组件的消息
- 搜索 "bug fix" - 会找到所有提到 bug 修复的消息
- 搜索多个关键词 "api authentication" - 会找到同时包含 "api" 和 "authentication" 的消息

### 搜索结果排序

搜索结果按以下因素排序：
1. 匹配度（关键词匹配数量、顺序和距离）
2. 时效性（越新的消息权重越高）
3. 结果来源类型

## 技术实现

### 核心函数

#### `scanSessionMessages(url:pattern:maxMatches:fallbackTitle:metadataDate:)`

专门用于扫描会话文件并提取消息的函数：
- 逐行解析 JSONL 文件
- 识别消息类型（user_message / agent_message / agent_reasoning）
- 提取消息文本并处理 JSON 转义序列
- 对消息内容进行模糊搜索匹配
- 返回匹配的搜索结果

#### `scanSession(url:pattern:chunkSize:snippetRadius:maxMatches:)`

修改后的主扫描函数：
- 首先调用 `scanSessionMessages` 搜索消息
- 如果消息搜索结果不足，回退到原始的文件内容扫描
- 确保兼容性和完整的搜索覆盖

### 匹配算法

模糊搜索使用以下评分策略：
- **覆盖率**：匹配的关键词数量 / 总关键词数量
- **紧密度**：匹配关键词在文本中的跨度
- **顺序度**：关键词出现顺序的匹配程度
- **位置权重**：匹配位置靠前的结果权重更高
- **时效性**：最近的消息获得额外权重（最多 +0.25）

### 消息标识

搜索结果中的消息标识：
- `User: ` - 表示这是用户发送的消息
- `Assistant: ` - 表示这是助手（AI）回复的消息

## 未来改进

可能的改进方向：
1. 添加消息类型过滤（仅搜索用户消息或仅搜索助手消息）
2. 支持更复杂的消息搜索语法（例如："user:react" 只搜索用户消息）
3. 支持消息的时间范围过滤
4. 添加消息跳转功能，点击搜索结果直接定位到消息在对话中的位置
5. 支持搜索 reasoning（推理）消息
6. 支持同时搜索工具调用和消息

## 兼容性

- 兼容所有现有的会话格式（Codex、Claude、Gemini、Pi）
- 不影响现有的搜索功能和结果
- 向后兼容，无需修改已有会话文件
